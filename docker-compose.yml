services:
  # 1. Wrangler
  # docker-compose up wrangler
  wrangler:
    build:
      context: .
      target: wrangler-container
    volumes:
      - .:/app
      - /app/node_modules
    ports:
      - "3000:8787"
    environment:
      - NODE_ENV=development
      - VALID_KEYS=${VALID_KEYS}
      - HOST=0.0.0.0
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8787/proxy/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Node
  # docker-compose up node
  node:
    build:
      context: .
      target: node-container
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - VALID_KEYS=${VALID_KEYS}
      - PORT=3000
      - HOST=0.0.0.0
    command: npm start
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/proxy/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 3. Gemini
  # docker-compose up -d gemini
  # docker-compose exec gemini gemini
  gemini:
    build:
      context: .
      target: gemini-container
    volumes:
      - .:/app
      - /app/node_modules
      - ~/.config/gcloud:/root/.config/gcloud # Persistent Auth
    environment:
      - NODE_ENV=development
      - GOOGLE_GENAI_USE_GCA=1
    stdin_open: true
    tty: true
    # Profiles allow you to start this only when needed
    profiles: ["tools"]

  # 4. E2E Node Tests
  # docker-compose up test-e2e-node
  test-e2e-node:
    build:
      context: .
      target: node-container
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - VALID_KEYS=${VALID_KEYS}
      - TEST_PROXY_URL=http://node:3000
    depends_on:
      node:
        condition: service_healthy
    command: node tests/proxy-test-end2end-w3c-validation.js

  # 5. E2E Wrangler Tests
  # docker-compose up test-e2e-wrangler
  test-e2e-wrangler:
    build:
      context: .
      target: wrangler-container
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - VALID_KEYS=${VALID_KEYS}
      - TEST_PROXY_URL=http://wrangler:8787
    depends_on:
      wrangler:
        condition: service_healthy
    command: node tests/proxy-test-end2end-w3c-validation.js